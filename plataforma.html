<!DOCTYPE html>
<html>
	<head>
		<title>Teste</title>
		<meta charset="utf-8" />
		<script src="sprite.js" charset="utf-8"></script>
	</head>
	<body>
		<h1>Teste</h1>
		<canvas id="tela" width="640" height="320"></canvas>
		<script>
			var NUM_ENEMIES= 5;
			var tela = document.getElementById('tela');
			var ctx = tela.getContext('2d');

			var imgPc = new Image();
			imgPc.src = 'pc.svg';
			var imgWall = new Image();
			imgWall.src = 'wall.svg';
			var imgBlock = new Image();
			imgBlock.src = 'block.svg';
			var imgCoin = new Image();
			imgCoin.src = 'coin.svg';

			var x = 0;
			var fps = 60;
			var dt = 1.0/fps;
			var g = 300;
			var mapa = [
				[1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1],
				[1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,1,1,0, 0,1,1,0,0, 0,0,1,1,1, 0,0,0,1,1],
				[1,0,0,0,0, 0,0,0,0,0, 1,1,0,0,0, 0,0,1,0,1],
				[1,1,1,1,0, 1,0,0,0,0, 0,0,0,0,0, 0,0,0,0,1],
				[1,0,0,0,0, 0,0,0,1,1, 0,1,1,1,0, 1,0,0,0,1],
				[1,0,0,1,1, 0,0,0,0,0, 0,0,0,0,0, 0,0,1,0,1],
				[1,0,0,0,0, 0,0,1,1,1, 0,0,0,0,0, 0,1,0,0,1],
				[1,0,0,0,0, 1,1,1,1,1, 1,1,0,0,0, 1,0,0,1,1],
				[1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1]
			];

			var pc = new SpriteInMap();
			pc.imune = 0;
			var inimigos = [];
			for(var i=0; i<NUM_ENEMIES; i++){
				inimigos[i] = new SpriteInMap();
				inimigos[i].imgY = 1;
				inimigos[i].spriteSrc = imgPc;
				inimigos[i].x = 15*32-Math.random()*32+32*i;
				inimigos[i].persegue = function(pc){
					if(pc.x < this.x){
						this.vx = -35;
					}else if (pc.x > this.x){
						this.vx = +35;
					}
					if(pc.y<this.y && mapa[this.my+1][this.mx]==1 && this.vy == 0 && mapa[this.my-1][this.mx]==0){
						this.vy -= 220;
					}
				};
			}
			setInterval(desenha, 1000*dt);
			//desenhaMapa();

			var coin = new SpriteInMap();
			coin.spriteSrc = imgCoin;
			coin.x = Math.random()*15*32+32;

			function desenha(){
				for(var i=0; i<NUM_ENEMIES; i++){
					if(pc.imune<=0 && inimigos[i].colidiuCom(pc)){
						pc.x = 240;
						pc.y = 40;
						pc.vy = 0;
						pc.imune = 3;
					}
					for(var j=i+1; j<NUM_ENEMIES; j++){
						if(inimigos[i].colidiuCom(inimigos[j])){
							inimigos[j].x = 20*32-Math.random()*32;
							inimigos[j].y = 32;
							inimigos[j].vy = 0;
						}
					}
				}
				if(coin.colidiuCom(pc)){
					coin.x = Math.random()*15*32+32;
					coin.y = 40;
					coin.vy = 0;
				}
				pc.move(dt);
				pc.imune -= dt;
				for(var i=0; i<NUM_ENEMIES; i++){
					inimigos[i].move(dt);
					inimigos[i].persegue(pc);
				}
				//ctx.clearRect(0,0,tela.width,tela.height);

				desenhaMapa();
				ctx.fillText(x++,50,20);
				pc.desenha(ctx);
				for(var i=0; i<NUM_ENEMIES; i++){
					inimigos[i].desenha(ctx);
				}
				coin.move(dt);
				coin.desenha(ctx);
			}

			function desenhaMapa(){
				var linhas = tela.height/32;
				var colunas = tela.width/32;
				for (var l = 0; l < linhas; l++) {
					for (var c = 0; c < colunas; c++) {
						if(mapa[l][c]==0){
							ctx.drawImage(imgWall,c*32,l*32);
						} else {
							ctx.drawImage(imgBlock,c*32,l*32);
						}
					}
				}
			}

			addEventListener('keydown', function(e){
				switch(e.keyCode){
					case 37:
						pc.vx = -80;
						e.preventDefault();
						break;
					case 38:
						if(pc.vy == 0 && mapa[pc.my+1][pc.mx] == 1){
							pc.vy = pc.vy -230;
						}
						e.preventDefault();
						break;
					case 39:
						pc.vx =  80;
						e.preventDefault();
						break;

				}
			});
			addEventListener('keyup', function(e){
				switch(e.keyCode){
					case 37:
					case 39:
						pc.vx = 0;
						e.preventDefault();
						break;
					case 38:
						pc.ay = 0;
						e.preventDefault();
						break;
				}
			});
		</script>
	</body>
</html>
